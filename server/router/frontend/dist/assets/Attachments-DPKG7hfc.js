import{r as f,j as e,ae as D,af as H,c as M,ag as $,ah as V,ai as R,aj as U,ak as B,al as Q,am as k,d as K,_ as O,h as W,k as b,n as v,w as Y,an as G,ao as Z,I as J,a2 as X,ap as ee,B as P,T as te,aq as ae,t as T,x as se,ar as le}from"./index-DE0IHRRq.js";import{aD as N}from"./mermaid-vendor-B8wVipH8.js";import{r as i,R as ne}from"./leaflet-vendor-CTVbxAuc.js";import{S as re}from"./separator-C1TU6OOC.js";import{u as ce}from"./useDialog-CArrf6wl.js";import"./utils-vendor-D86ln76_.js";const ie=[["rect",{x:"14",y:"14",width:"4",height:"6",rx:"2",key:"p02svl"}],["rect",{x:"6",y:"4",width:"4",height:"6",rx:"2",key:"xm4xkj"}],["path",{d:"M6 20h4",key:"1i6q5t"}],["path",{d:"M14 10h4",key:"ru81e7"}],["path",{d:"M6 14h2v6",key:"16z9wg"}],["path",{d:"M14 4h2v6",key:"1idq9u"}]],oe=f("binary",ie);const me=[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20",key:"k3hazp"}]],q=f("book",me);const de=[["path",{d:"M10 12v-1",key:"v7bkov"}],["path",{d:"M10 18v-2",key:"1cjy8d"}],["path",{d:"M10 7V6",key:"dljcrl"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M15.5 22H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v16a2 2 0 0 0 .274 1.01",key:"gkbcor"}],["circle",{cx:"10",cy:"20",r:"2",key:"1xzdoj"}]],ue=f("file-archive",de);const he=[["path",{d:"M17.5 22h.5a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v3",key:"rslqgf"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M2 19a2 2 0 1 1 4 0v1a2 2 0 1 1-4 0v-4a6 6 0 0 1 12 0v4a2 2 0 1 1-4 0v-1a2 2 0 1 1 4 0",key:"9f7x3i"}]],xe=f("file-audio",he);const fe=[["path",{d:"M12.5 22H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v9.5",key:"1couwa"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M13.378 15.626a1 1 0 1 0-3.004-3.004l-5.01 5.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z",key:"1y4qbx"}]],pe=f("file-pen",fe);const ye=[["path",{d:"M4 22h14a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v4",key:"1pf5j1"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["rect",{width:"8",height:"6",x:"2",y:"12",rx:"1",key:"1a6c1e"}],["path",{d:"m10 13.843 3.033-1.755a.645.645 0 0 1 .967.56v4.704a.645.645 0 0 1-.967.56L10 16.157",key:"vd9ei0"}]],we=f("file-video-camera",ye);const ge=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["line",{x1:"3",x2:"21",y1:"9",y2:"9",key:"1vqk6q"}],["line",{x1:"3",x2:"21",y1:"15",y2:"15",key:"o2sbyz"}],["line",{x1:"9",x2:"9",y1:"9",y2:"21",key:"1ib60c"}],["line",{x1:"15",x2:"15",y1:"9",y2:"21",key:"1n26ft"}]],je=f("sheet",ge),ve=t=>{const{children:s,className:c}=t,l=t.baseSide||"width",n=i.useRef(null);return i.useEffect(()=>{const r=()=>{if(n.current)if(l==="width"){const o=n.current.clientWidth;n.current.style.height=o+"px"}else{const o=n.current.clientHeight;n.current.style.width=o+"px"}};return r(),window.addEventListener("resize",r),()=>{window.removeEventListener("resize",r)}},[]),e.jsx("div",{ref:n,className:`${[l==="width"?"w-full":"h-full",c??""].join(" ")}`,children:s})},ke=t=>{const{attachment:s}=t,[c,l]=i.useState({open:!1,urls:[],index:0}),n=D(s),r=H(s),o=M("w-full h-auto",t.className),m=t.strokeWidth,p=()=>{window.open(r)},y=()=>{l({open:!0,urls:[r],index:0})};if(n==="image/*")return e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:M(o,"flex items-center justify-center overflow-clip"),children:e.jsx("img",{className:"min-w-full min-h-full object-cover",src:$(s),onClick:y,onError:h=>{const x=h.target;x.src.includes("?thumbnail=true")&&(console.warn("Thumbnail failed, falling back to original image:",r),x.src=r)},decoding:"async",loading:"lazy"})}),e.jsx(V,{open:c.open,onOpenChange:h=>l(x=>({...x,open:h})),imgUrls:c.urls,initialIndex:c.index})]});const g=()=>{switch(n){case"video/*":return e.jsx(we,{strokeWidth:m,className:"w-full h-auto"});case"audio/*":return e.jsx(xe,{strokeWidth:m,className:"w-full h-auto"});case"text/*":return e.jsx(U,{strokeWidth:m,className:"w-full h-auto"});case"application/epub+zip":return e.jsx(q,{strokeWidth:m,className:"w-full h-auto"});case"application/pdf":return e.jsx(q,{strokeWidth:m,className:"w-full h-auto"});case"application/msword":return e.jsx(pe,{strokeWidth:m,className:"w-full h-auto"});case"application/msexcel":return e.jsx(je,{strokeWidth:m,className:"w-full h-auto"});case"application/zip":return e.jsx(ue,{onClick:p,strokeWidth:m,className:"w-full h-auto"});case"application/x-java-archive":return e.jsx(oe,{strokeWidth:m,className:"w-full h-auto"});default:return e.jsx(R,{strokeWidth:m,className:"w-full h-auto"})}};return e.jsx("div",{onClick:p,className:M(o,"max-w-16 opacity-50"),children:g()})},Ne=ne.memo(ke),w={all:["attachments"],lists:()=>[...w.all,"list"],list:t=>[...w.lists(),t],details:()=>[...w.all,"detail"],detail:t=>[...w.details(),t]};function be(){const t=B();return Q({mutationFn:async s=>(await k.deleteAttachment({name:s}),s),onSuccess:s=>{t.removeQueries({queryKey:w.detail(s)}),t.invalidateQueries({queryKey:w.lists()})}})}const S=50,Ae=t=>{const s=new Map,c=[...t].sort((l,n)=>{const r=l.createTime?T(l.createTime):void 0,o=n.createTime?T(n.createTime):void 0;return N(o).unix()-N(r).unix()});for(const l of c){const n=l.createTime?T(l.createTime):void 0,r=N(n).format("YYYY-MM"),o=s.get(r)??[];o.push(l),s.set(r,o)}return s},Me=(t,s)=>{if(!s.trim())return t;const c=s.toLowerCase();return t.filter(l=>l.filename.toLowerCase().includes(c))},z=({attachment:t})=>e.jsxs("div",{className:"w-24 sm:w-32 h-auto flex flex-col justify-start items-start",children:[e.jsx("div",{className:"w-24 h-24 flex justify-center items-center sm:w-32 sm:h-32 border border-border overflow-clip rounded-xl cursor-pointer hover:shadow hover:opacity-80",children:e.jsx(Ne,{attachment:t,strokeWidth:.5})}),e.jsxs("div",{className:"w-full max-w-full flex flex-row justify-between items-center mt-1 px-1",children:[e.jsx("p",{className:"text-xs shrink text-muted-foreground truncate",children:t.filename}),t.memo&&e.jsx(se,{to:`/${t.memo}`,className:"text-primary hover:opacity-80 transition-opacity shrink-0 ml-1","aria-label":"View memo",children:e.jsx(le,{className:"w-3 h-3"})})]})]}),ze=()=>{const t=K(),s=O("md"),c=W(),l=ce(),{mutateAsync:n}=be(),[r,o]=i.useState(""),[m,p]=i.useState([]),[y,g]=i.useState(""),[h,x]=i.useState(!1),j=i.useMemo(()=>Me(m,r),[m,r]),C=i.useMemo(()=>j.filter(a=>a.memo),[j]),A=i.useMemo(()=>j.filter(a=>!a.memo),[j]),L=i.useMemo(()=>Ae(C),[C]);i.useEffect(()=>{(async()=>{try{const{attachments:d,nextPageToken:u}=await k.listAttachments({pageSize:S});p(d),g(u??"")}catch(d){b(d,v.error,{context:"Failed to fetch attachments",fallbackMessage:"Failed to load attachments. Please try again."})}finally{c.setFinish()}})()},[]);const _=i.useCallback(async()=>{if(!(!y||h)){x(!0);try{const{attachments:a,nextPageToken:d}=await k.listAttachments({pageSize:S,pageToken:y});p(u=>[...u,...a]),g(d??"")}catch(a){b(a,v.error,{context:"Failed to load more attachments",fallbackMessage:"Failed to load more attachments. Please try again."})}finally{x(!1)}}},[y,h]),F=i.useCallback(async()=>{try{c.setLoading();const{attachments:a,nextPageToken:d}=await k.listAttachments({pageSize:S});p(a),g(d??""),c.setFinish()}catch(a){b(a,v.error,{context:"Failed to refetch attachments",fallbackMessage:"Failed to refresh attachments. Please try again.",onError:()=>c.setError()})}},[c]),I=i.useCallback(async()=>{try{let a=[],d="";do{const u=await k.listAttachments({pageSize:1e3,pageToken:d,filter:"memo_id == null"});a=[...a,...u.attachments],d=u.nextPageToken}while(d);await Promise.all(a.map(u=>n(u.name))),v.success(t("resource.delete-all-unused-success"))}catch(a){b(a,v.error,{context:"Failed to delete unused attachments",fallbackMessage:t("resource.delete-all-unused-error")})}finally{await F()}},[t,F,n]),E=i.useCallback(a=>{o(a.target.value)},[]);return e.jsxs("section",{className:"@container w-full max-w-5xl min-h-full flex flex-col justify-start items-center sm:pt-3 md:pt-6 pb-8",children:[!s&&e.jsx(Y,{}),e.jsx("div",{className:"w-full px-4 sm:px-6",children:e.jsxs("div",{className:"w-full border border-border flex flex-col justify-start items-start px-4 py-3 rounded-xl bg-background text-foreground",children:[e.jsxs("div",{className:"relative w-full flex flex-row justify-between items-center",children:[e.jsxs("p",{className:"py-1 flex flex-row justify-start items-center select-none opacity-80",children:[e.jsx(G,{className:"w-6 h-auto mr-1 opacity-80"}),e.jsx("span",{className:"text-lg",children:t("common.attachments")})]}),e.jsx("div",{children:e.jsxs("div",{className:"relative max-w-32",children:[e.jsx(Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(J,{className:"pl-9",placeholder:t("common.search"),value:r,onChange:E})]})})]}),e.jsx("div",{className:"w-full flex flex-col justify-start items-start mt-4 mb-6",children:c.isLoading?e.jsx("div",{className:"w-full h-32 flex flex-col justify-center items-center",children:e.jsx("p",{className:"w-full text-center text-base my-6 mt-8",children:t("resource.fetching-data")})}):e.jsx(e.Fragment,{children:j.length===0?e.jsxs("div",{className:"w-full mt-8 mb-8 flex flex-col justify-center items-center italic",children:[e.jsx(X,{}),e.jsx("p",{className:"mt-4 text-muted-foreground",children:t("message.no-data")})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-full h-auto px-2 flex flex-col justify-start items-start gap-y-8",children:[Array.from(L.entries()).map(([a,d])=>e.jsxs("div",{className:"w-full flex flex-row justify-start items-start",children:[e.jsxs("div",{className:"w-16 sm:w-24 pt-4 sm:pl-4 flex flex-col justify-start items-start",children:[e.jsx("span",{className:"text-sm opacity-60",children:N(a).year()}),e.jsx("span",{className:"font-medium text-xl",children:N(a).toDate().toLocaleString(ee.language,{month:"short"})})]}),e.jsx("div",{className:"w-full max-w-[calc(100%-4rem)] sm:max-w-[calc(100%-6rem)] flex flex-row justify-start items-start gap-4 flex-wrap",children:d.map(u=>e.jsx(z,{attachment:u},u.name))})]},a)),A.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(re,{}),e.jsxs("div",{className:"w-full flex flex-row justify-start items-start",children:[e.jsx("div",{className:"w-16 sm:w-24 sm:pl-4 flex flex-col justify-start items-start"}),e.jsxs("div",{className:"w-full max-w-[calc(100%-4rem)] sm:max-w-[calc(100%-6rem)] flex flex-row justify-start items-start gap-4 flex-wrap",children:[e.jsxs("div",{className:"w-full flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[e.jsxs("div",{className:"flex flex-row items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:t("resource.unused-resources")}),e.jsxs("span",{className:"text-muted-foreground opacity-80",children:["(",A.length,")"]})]}),e.jsx("div",{children:e.jsxs(P,{variant:"destructive",onClick:()=>l.open(),size:"sm",children:[e.jsx(te,{}),t("resource.delete-all-unused")]})})]}),A.map(a=>e.jsx(z,{attachment:a},a.name))]})]})]})]}),y&&e.jsx("div",{className:"w-full flex flex-row justify-center items-center mt-4",children:e.jsx(P,{variant:"outline",size:"sm",onClick:_,disabled:h,children:t(h?"resource.fetching-data":"memo.load-more")})})]})})})]})}),e.jsx(ae,{open:l.isOpen,onOpenChange:l.setOpen,title:t("resource.delete-all-unused-confirm"),confirmLabel:t("common.delete"),cancelLabel:t("common.cancel"),onConfirm:I,confirmVariant:"destructive"})]})};export{ze as default};
